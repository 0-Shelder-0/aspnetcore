<Project Sdk="Microsoft.NET.Sdk">

  <Import Project="..\..\build\common.props" />

  <PropertyGroup>
    <TargetFramework>netcoreapp1.1</TargetFramework>
    <UserSecretsId>MusicStore.E2ETests</UserSecretsId>
    <OutputType>Exe</OutputType>
    <TreatWarningsAsErrors>true</TreatWarningsAsErrors>
    <RuntimeIdentifiers>win7-x86;win7-x64;osx.10.10-x64;osx.10.11-x64;ubuntu.14.04-x64;ubuntu.14.10-x64;ubuntu.15.04-x64;ubuntu.16.04-x64;centos.7-x64;debian.8-x64</RuntimeIdentifiers>
  </PropertyGroup>

  <ItemGroup>
    <None Include="*.config" CopyToOutputDirectory="PreserveNewest" />
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.AspNetCore.Authentication.Cookies" Version="1.2.0-*" />
    <PackageReference Include="Microsoft.AspNetCore.Authentication.OpenIdConnect" Version="1.2.0-*" />
    <PackageReference Include="Microsoft.AspNetCore.Identity" Version="1.2.0-*" />
    <PackageReference Include="Microsoft.AspNetCore.Server.IntegrationTesting" Version="0.3.0-*" />
    <PackageReference Include="Microsoft.AspNetCore.WebUtilities" Version="1.2.0-*" />
    <PackageReference Include="Microsoft.DotNet.PlatformAbstractions" Version="1.2.0-*" />
    <PackageReference Include="Microsoft.Extensions.Configuration.Binder" Version="1.2.0-*" />
    <PackageReference Include="Microsoft.Extensions.Configuration.EnvironmentVariables" Version="1.2.0-*" />
    <PackageReference Include="Microsoft.Extensions.Configuration.Json" Version="1.2.0-*" />
    <PackageReference Include="Microsoft.Extensions.Configuration.UserSecrets" Version="1.2.0-*" />
    <PackageReference Include="Microsoft.Extensions.Logging.Console" Version="1.2.0-*" />
    <PackageReference Include="Microsoft.Extensions.Logging" Version="1.2.0-*" />
    <PackageReference Include="Microsoft.NET.Test.Sdk" Version="15.0.0-*" />
    <PackageReference Include="System.Data.SqlClient" Version="4.4.0-*" />
    <PackageReference Include="System.Xml.XmlDocument" Version="4.4.0-*" />
    <PackageReference Include="xunit.runner.visualstudio" Version="2.2.0-*" />
    <PackageReference Include="xunit" Version="2.2.0-*" />
    <DotNetCliToolReference Include="Microsoft.Extensions.SecretManager.Tools" Version="1.0.1-*" />
  </ItemGroup>

  <!-- workaround inability to filter by traits using xunit.runner.visualstudio -->
  <PropertyGroup>
    <XunitConsoleVersion>2.2.0-preview2-build1029</XunitConsoleVersion>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="dotnet-test-xunit" Version="$(XunitConsoleVersion)" />
  </ItemGroup>

  <Target Name="TestNano" DependsOnTargets="Build">

    <ItemGroup>
      <CopyTestFiles Include="$(NuGetPackageRoot)dotnet-test-xunit\$(XunitConsoleVersion)\lib\netcoreapp1.0\dotnet-test-xunit.dll">
        <RelativePath>dotnet-test-xunit.dll</RelativePath>
      </CopyTestFiles>
      <CopyTestFiles Include="$(ProjectDepsFilePath)">
        <RelativePath>dotnet-test-xunit.deps.json</RelativePath>
      </CopyTestFiles>
        <CopyTestFiles Include="$(ProjectRuntimeConfigFilePath)">
        <RelativePath>dotnet-test-xunit.runtimeconfig.json</RelativePath>
      </CopyTestFiles>
      <CopyTestFiles Include="$(ProjectRuntimeConfigDevFilePath)">
        <RelativePath>dotnet-test-xunit.runtimeconfig.dev.json</RelativePath>
      </CopyTestFiles>
    </ItemGroup>

    <Copy SourceFiles="%(CopyTestFiles.Identity)" DestinationFiles="$(OutputPath)\%(RelativePath)" />

    <Exec Command="dotnet dotnet-test-xunit.dll $(AssemblyName).dll -parallel None -trait E2ETests=NanoServer"
          WorkingDirectory="$(OutputPath)" />
  </Target>
  <!-- end workaround -->

</Project>
