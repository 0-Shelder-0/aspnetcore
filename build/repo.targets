<Project>

  <PropertyGroup>
    <CompileDependsOn Condition="'$(OS)'=='Windows_NT'">BuildNativeAssets;$(CompileDependsOn)</CompileDependsOn>
    <PackageDependsOn Condition="'$(OS)'=='Windows_NT'">$(PackageDependsOn);PackageNativeProjects</PackageDependsOn>
  </PropertyGroup>

  <Target Name="BuildNativeAssets" DependsOnTargets="GetToolsets" >
    <ItemGroup>
      <BuildConfigurations Include="/p:Configuration=$(Configuration) /p:platform=Win32" />
      <BuildConfigurations Include="/p:Configuration=$(Configuration) /p:platform=x64" />
    </ItemGroup>

    <Error
      Text="Could not find an installation of Visual Studio with the C++ development tools."
      Condition="'$(VisualStudioMSBuildx86Path)' == ''" />
      
    <Exec Command="&quot;$(VisualStudioMSBuildx86Path)&quot; &quot;$(RepositoryRoot)src\AspNetCore\AspNetCore.vcxproj&quot; %(BuildConfigurations.Identity)"
      Condition="'$(VisualStudioMSBuildx86Path)' != ''" />
    <Exec Command="&quot;$(VisualStudioMSBuildx86Path)&quot; &quot;$(RepositoryRoot)src\RequestHandler\RequestHandler.vcxproj&quot; %(BuildConfigurations.Identity)"
      Condition="'$(VisualStudioMSBuildx86Path)' != ''" />
  </Target>

  <ItemGroup>
    <ArtifactInfo Include="$(BuildDir)Microsoft.AspNetCore.AspNetCoreModule.$(PackageVersion).nupkg">
      <ArtifactType>NuGetPackage</ArtifactType>
      <PackageId>Microsoft.AspNetCore.AspNetCoreModule</PackageId>
      <Version>$(PackageVersion)</Version>
      <RepositoryRoot>$(RepositoryRoot)</RepositoryRoot>
    </ArtifactInfo>
    <FilesToExcludeFromSigning Include="$(BuildDir)Microsoft.AspNetCore.AspNetCoreModule.$(PackageVersion).nupkg" />
  </ItemGroup>


  <Target Name="PackageNativeProjects">
    <PackNuspec NuspecPath="$(MSBuildThisFileDirectory)..\nuget\AspNetCore.nuspec"
      DestinationFolder="$(BuildDir)"
      Properties="version=$(PackageVersion);Configuration=$(Configuration)"
      BasePath="$(RepositoryRoot)" />
  </Target>
  
</Project>