<Project>
  <PropertyGroup>
    <TemplatingProjectRoot>$(MSBuildThisFileDirectory)..\modules\Templating\</TemplatingProjectRoot>
    <GetArtifactInfoDependsOn>$(GetArtifactInfoDependsOn);GetTemplateArtifactInfo</GetArtifactInfoDependsOn>
  </PropertyGroup>

  <PropertyGroup>
    <TemplateProjProperties>
      RepositoryRoot=$(TemplatingProjectRoot);
      BuildNumber=$(BuildNumber);
      Configuration=$(Configuration);
      IsFinalBuild=$(IsFinalBuild);
    </TemplateProjProperties>
  </PropertyGroup>

  <Target Name="GetTemplateArtifactInfo">
    <MSBuild Projects="$(MSBuildProjectFullPath)"
      Targets="GetArtifactInfo"
      Properties="$(TemplateProjProperties);DesignTimeBuild=true">
      <Output TaskParameter="TargetOutputs" ItemName="ArtifactInfo" />
    </MSBuild>
  </Target>

  <Target Name="BuildTemplates" DependsOnTargets="GeneratePropsFiles">
    <PropertyGroup>
      <_BuildTemplateProjProperties>
        $(TemplateProjProperties);
        SkipAspNetCoreRuntimeInstall=true;
        DotNetRestoreSourcePropsPath=$(GeneratedRestoreSourcesPropsPath);
        DotNetPackageVersionPropsPath=$(GeneratedPackageVersionPropsPath);
        SkipTests=true;
      </_BuildTemplateProjProperties>
    </PropertyGroup>

    <MSBuild Projects="$(MSBuildProjectFullPath)"
             Targets="CleanArtifacts;Build"
             Properties="$(_BuildTemplateProjProperties)" />

    <ItemGroup>
      <TemplateArtifacts Include="$(TemplatingProjectRoot)artifacts\build\*" />
    </ItemGroup>

    <Copy SourceFiles="@(TemplateArtifacts)" DestinationFolder="$(BuildDir)" />
  </Target>

</Project>
