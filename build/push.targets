<Project>
  <Target Name="Push" DependsOnTargets="_PushNuGet;_PushNpm" />

  <ItemGroup>
    <PackagesToPush Include="$(BuildDir)*.nupkg" />
    <PackagesToPush Include="$(ArtifactsDir)mirror\*.nupkg" />
    <PackagesToPush Include="$(LineupBuildDir)*.nupkg" />
  </ItemGroup>

  <Target Name="_PushNuGet" Condition="@(PackagesToPush->Count()) != 0">
    <Error Text="Missing required property: NuGetPublishFeed"  Condition=" '$(NuGetPublishFeed)' == '' "/>
    <PushNuGetPackages
      Packages="@(PackagesToPush)"
      Feed="$(NuGetPublishFeed)"
      ApiKey="$(APIKey)" />
  </Target>

  <ItemGroup>
    <NpmModuleArtifact Include="$(BuildDir)*.tgz" />
  </ItemGroup>

  <Target Name="_PushNpm" Condition="@(NpmModuleArtifact->Count()) != 0">
    <Error Text="Missing required property: NpmRegistry"  Condition=" '$(NpmRegistry)' == '' "/>

    <PropertyGroup>
      <AuthTokenSetting>$(NpmRegistry.Replace("https:", "")):_authToken</AuthTokenSetting>
    </PropertyGroup>

    <Exec Command="npm config set &quot;$(AuthTokenSetting)&quot; $(APIKey)" Condition=" '$(APIKey)' != '' " />
    <Exec Command="npm publish --registry $(NpmRegistry) &quot;%(NpmModuleArtifact.Identity)&quot;"
          ContinueOnError="true">
      <Output TaskParameter="ExitCode" ItemName="ExitCodes" />
    </Exec>
    <Exec Command="npm config delete $(AuthTokenSetting)" Condition=" '$(APIKey)' != '' "/>
    <Error Text="Publishing npm modules failed" Condition="%(ExitCodes.Identity) > 0"/>
  </Target>
</Project>
